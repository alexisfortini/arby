{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto pb-20">
    <!-- Header -->
    <div class="mb-8 text-center relative">
        <div class="flex items-center justify-center gap-2 mb-2">
            <span
                class="bg-green-100 text-green-700 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">Active
                Plan</span>
        </div>
        <h1 class="text-3xl font-black text-slate-800 tracking-tight">Shopping List</h1>
    </div>

    {% include 'active_plan_nav.html' %}

    <!-- Grocery Actions -->
    <div class="mt-4 mb-6 flex justify-center gap-3">
        <button id="pantryCheckBtn" onclick="runPantryCheck()"
            class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-full text-xs font-bold transition-all border border-indigo-100 shadow-sm">
            <span id="pantryCheckIcon">üë®‚Äçüç≥</span>
            <span id="pantryCheckText">Check Pantry</span>
        </button>
    </div>

    <div class="space-y-6">
        {% for day in plan.days %}
        <div class="space-y-4">
            <div class="flex items-center gap-3">
                <div class="h-px bg-slate-200 flex-grow"></div>
                <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{{ day.date }}</h2>
                <div class="h-px bg-slate-200 flex-grow"></div>
            </div>

            {% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
            {% set meal = day[meal_type] %}
            {% if meal %}
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-[10px] font-black uppercase text-slate-500 tracking-wider">{{ meal_type }}</span>
                    <span class="text-xs font-bold text-slate-800">{{ meal.name }}</span>
                </div>
                <div class="p-3 space-y-1">
                    {% for ing in meal.ingredients %}
                    {% set item_id = day.date ~ '-' ~ meal_type ~ '-' ~ loop.index0 %}
                    {% set checked = plan.checked_groceries.get(item_id, False) if plan.checked_groceries else False %}
                    {% set recommended = (item_id in plan.pantry_recommendations) if plan.pantry_recommendations else
                    False %}
                    <div id="item-{{ item_id }}"
                        class="flex items-center justify-between p-2 rounded-xl transition-all group 
                               {% if recommended and not checked %}bg-emerald-50/50 border border-emerald-100/50{% else %}hover:bg-slate-50{% endif %}">

                        <div class="flex items-center gap-3 flex-grow cursor-pointer"
                            onclick="toggleGrocery('{{ item_id }}', this)">
                            <div
                                class="check-box w-5 h-5 border-2 rounded flex-shrink-0 flex items-center justify-center transition-all
                                        {% if checked %}bg-blue-600 border-blue-600{% else %}border-slate-200 bg-white{% endif %}">
                                <svg class="w-3 h-3 text-white transition-transform {% if not checked %}scale-0{% endif %}"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span
                                class="text-sm font-medium text-slate-600 transition-all {% if checked %}line-through text-slate-400{% endif %}">
                                {{ ing }}
                            </span>
                        </div>

                        <div class="flex items-center gap-2">
                            <button data-ingredient="{{ ing }}" data-item-id="{{ item_id }}"
                                onclick="addOneToPantry(this)"
                                class="opacity-0 group-hover:opacity-100 transition-opacity text-[10px] font-bold text-blue-600 hover:bg-blue-50 px-2 py-1 rounded-lg flex items-center gap-1 border border-blue-100">
                                <span>+ Pantry</span>
                            </button>

                            {% if recommended and not checked %}
                            <span
                                class="text-[9px] font-black uppercase text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full tracking-tighter">You
                                Have This</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function runPantryCheck() {
        const btn = document.getElementById('pantryCheckBtn');
        const icon = document.getElementById('pantryCheckIcon');
        const text = document.getElementById('pantryCheckText');

        btn.disabled = true;
        btn.classList.add('opacity-50', 'hover:bg-indigo-50');
        icon.classList.add('animate-bounce');
        text.innerText = "Checking inventory...";

        fetch('/api/plan/grocery/pantry_check', {
            method: 'POST'
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Refresh the page to show recommendations
                    window.location.reload();
                } else {
                    alert("Pantry check failed: " + data.message);
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    icon.classList.remove('animate-bounce');
                    text.innerText = "Check Pantry";
                }
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                icon.classList.remove('animate-bounce');
                text.innerText = "Check Pantry";
            });
    }

    function addOneToPantry(btn) {
        const ing = btn.getAttribute('data-ingredient');
        const itemId = btn.getAttribute('data-item-id');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

        fetch('/api/plan/grocery/add_one_to_pantry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredient: ing, item_id: itemId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Success! Show checkmark then fade or reload
                    btn.innerHTML = '‚úÖ';
                    setTimeout(() => window.location.reload(), 800);
                } else {
                    alert("Error adding item: " + data.message);
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
    }

    function toggleGrocery(itemId, element) {
        const box = element.querySelector('.check-box');
        const svg = box.querySelector('svg');
        const text = element.querySelector('span');

        fetch('/api/plan/grocery/toggle_meal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    if (data.checked) {
                        box.classList.remove('border-slate-200', 'bg-white');
                        box.classList.add('bg-blue-600', 'border-blue-600');
                        svg.classList.remove('scale-0');
                        text.classList.add('line-through', 'text-slate-400');
                    } else {
                        box.classList.add('border-slate-200', 'bg-white');
                        box.classList.remove('bg-blue-600', 'border-blue-600');
                        svg.classList.add('scale-0');
                        text.classList.remove('line-through', 'text-slate-400');
                    }
                }
            })
            .catch(err => console.error(err));
    }
</script>
{% endblock %}