{% extends "base.html" %}

{% block content %}

<div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-slate-800">Meal History</h1>
    <a href="/" class="text-sm font-semibold text-slate-500 hover:text-slate-800">Back</a>
</div>

<div class="space-y-6">
    {% for idx, entry in history %}
    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
            <h2 class="font-bold text-slate-700">{{ entry.date }}</h2>
            <div class="flex gap-2">
                <button onclick="openReviewModal({{ idx }})"
                    class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg font-semibold hover:bg-indigo-200">
                    ‚≠ê Review
                </button>
                <form action="/history/delete/{{ idx }}" method="POST"
                    onsubmit="return confirm('Delete this history entry?')">
                    <button type="submit"
                        class="text-sm bg-red-50 text-red-500 px-3 py-1 rounded-lg font-semibold hover:bg-red-100">
                        üóëÔ∏è
                    </button>
                </form>
            </div>
        </div>
        <div class="p-4 prose prose-sm max-w-none text-slate-600">
            <div class="mb-4 whitespace-pre-line">{{ entry.summary }}</div>

            {% if entry.meals %}
            <div class="border-t border-slate-100 pt-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Meals & Ratings</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {% for meal in entry.meals %}
                    <div class="flex items-center justify-between p-2 rounded-lg bg-slate-50 border border-slate-100">
                        <span class="text-xs font-bold text-slate-700 truncate mr-2">{{ meal.name }}</span>
                        <div class="flex items-center gap-1">
                            {% for i in range(1, 6) %}
                            <form action="/history/rate/{{ idx }}/{{ loop.index0 }}/{{ i }}" method="POST"
                                class="inline">
                                <button type="submit"
                                    class="text-xs {{ 'text-yellow-400' if i <= (meal.rating|int) else 'text-slate-300' }} hover:scale-125 transition-transform">
                                    ‚òÖ
                                </button>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Review Modal -->
<div id="reviewModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <h3 class="text-xl font-bold">Review Meal Plan</h3>
            <button onclick="closeReviewModal()" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        <form id="reviewForm" method="POST">
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-3">
                    Tell Arby what you thought about this week's meals.
                </p>
                <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 mb-3">
                    <strong>Tip:</strong> Say "I loved the [Recipe Name]" to save it to your book, or "I hated [Recipe
                    Name]" to never see it again.
                </div>
                <textarea name="feedback" rows="4"
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="e.g. The Chicken Curry was delicious! Please save it. I didn't like the Lentil Soup though."></textarea>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end space-x-2">
                <button type="button" onclick="closeReviewModal()"
                    class="px-4 py-2 text-slate-500 font-semibold hover:bg-slate-100 rounded-lg">Cancel</button>
                <button type="submit"
                    class="px-6 py-2 bg-slate-900 text-white font-semibold rounded-lg hover:opacity-90">Submit
                    Feedback</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openReviewModal(index) {
        document.getElementById('reviewForm').action = '/history/review/' + index;
        document.getElementById('reviewModal').classList.remove('hidden');
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
    }
</script>

{% endblock %}